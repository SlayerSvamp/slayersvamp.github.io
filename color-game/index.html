<head>
    <style>
        :root {
            --unit: min(1vw, 1.5vh, .5rem);
        }

        body {
            margin: 0;
            position: absolute;
            inset-inline: 0;
            height: 100vh;
            display: grid;
            gap: calc(var(--unit) * 2);
            align-content: center;
            justify-content: center;
            background-color: #222;
            text-align: center;
        }

        body * {
            font-size: calc(var(--unit) * 5);
            font-family: monospace;
            color: #fff;
        }

        div {
            display: grid;
            grid-auto-flow: column;
            gap: calc(var(--unit) * 4);
            justify-content: center;
            justify-items: center;
        }

        button {
            background-color: #000;
            border-radius: var(--unit);
            border: none;
            cursor: pointer;
            padding-block: calc(var(--unit) * 2);
        }
        

        #colors>button {
            aspect-ratio: 1;
            border-radius: 50%;
            width: calc(var(--unit) * 28);
        }

        #colors>button:focus {
            outline: var(--unit) solid #000;
        }

        #correct {
            zoom: 1.2;
        }


        #reset-highscore {
            display: grid;
            overflow: hidden;
            align-content: center;
            aspect-ratio: 1;
        }
    </style>
</head>

<body onload="reset()">
    <div id="colors">
        <button></button>
        <button></button>
        <button></button>
    </div>
    <div id="correct"></div>
    <button id="switch-mode" onclick="reset(true)">mode: <span id="mode-type"></span></button>
    <div id="scores">
        <span>Score: <span id="score"></span></span>
        <span>Highscore: <span id="highscore"></span></span>
        <button id="reset-highscore" title="reset highscore" onclick="resetHighscore()">&#x21ba;</>
    </div>
</body>

<script>
    function loadResource(key, defaultValue, validate) {
        const loaded = window.localStorage.getItem(key)
        if (!!loaded) {
            parsed = JSON.parse(loaded)
            if (!validate || validate(parsed)) {
                return parsed
            }
        }
        return defaultValue
    }

    function saveResource(key, value) {
        window.localStorage.setItem(key, JSON.stringify(value))
    }

    const modes = [
        values => `#${values.map(x => x.toString(16).padStart(2, '0')).join('')}`,
        values => `rgb(${values.join(', ')})`,
        values => [rgbToHsl(values)].map(([h, s, l]) => `hsl(${h}, ${s}%, ${l}%)`)[0],
    ].reverse()

    const blankHighscore = new Array(modes.length).fill(0)
    const colors = document.querySelectorAll('#colors > button')
    const modeType = document.querySelector('#mode-type')
    const correct = document.querySelector('#correct')
    const score = document.querySelector('#score')
    const highscore = document.querySelector('#highscore')
    const newGame = {
        score: 0,
        highscore: loadResource(
            'highscore',
            [...blankHighscore],
            x => x.length === modes.length,
        ),
        colors: [],
        mode: loadResource('mode', modes.length - 1),
    }
    let game = { ...newGame }

    function randomPart() { return Math.floor(Math.random() * 256) }
    function randomColor() { return modes[game.mode](new Array(3).fill(0).map(() => randomPart())) }

    function reset(switchMode) {
        if (switchMode) {
            game.mode = (game.mode || modes.length) - 1
            saveResource('mode', game.mode)
        }
        game.score = 0
        modeType.innerHTML = ['hsl', 'rgb', 'hex'][game.mode]
        next()
    }
    function next() {
        document.querySelector('#colors>:focus')?.blur()
        game.colors = new Array(3).fill(0).map(() => randomColor())
        game.chosen = Math.floor(Math.random() * game.colors.length);
        colors.forEach((c, i) => {
            c.style.backgroundColor = game.colors[i];
            if (i === game.chosen) {
                c.onclick = () => {
                    game.score++
                    game.highscore[game.mode] = Math.max(game.score, game.highscore[game.mode])
                    saveResource('highscore', game.highscore)
                    next()
                }
            }
            else {
                c.onclick = () => {
                    game.score = 0
                    next()
                }
            }
        })
        correct.innerHTML = game.colors[game.chosen]
        score.innerHTML = game.score
        highscore.innerHTML = game.highscore[game.mode]
    }

    function resetHighscore() {
        if (!confirm('Reset highscore?')) return;

        game.highscore[game.mode] = 0
        highscore.innerHTML = game.highscore[game.mode]
        saveResource('highscore', game.highscore)
    }

    const rgbToHsl = ([r, g, b]) => {
        r /= 255;
        g /= 255;
        b /= 255;
        const l = Math.max(r, g, b);
        const s = l - Math.min(r, g, b);
        const h = s
            ? l === r
                ? (g - b) / s
                : l === g
                    ? 2 + (b - r) / s
                    : 4 + (r - g) / s
            : 0;
        return [
            60 * h < 0 ? 60 * h + 360 : 60 * h,
            100 * (s ? (l <= 0.5 ? s / (2 * l - s) : s / (2 - (2 * l - s))) : 0),
            (100 * (2 * l - s)) / 2,
        ].map(Math.round)
    }
</script>